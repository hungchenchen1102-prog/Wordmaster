<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字特訓班 (修復發音版)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@500;700&display=swap');
        body { font-family: 'Roboto', 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

<div id="root" class="w-full max-w-md"></div>

<script type="text/babel">

// 完整的單字資料庫
const rawData = [
    { en: "make up for", ch: "補償；彌補" },
    { en: "give rise to", ch: "導致；引起" },
    { en: "odd", ch: "奇怪的；奇數的；零散的" },
    { en: "sole", ch: "唯一的；腳底；鞋底" },
    { en: "convert", ch: "轉變；改變信仰" },
    { en: "forbid", ch: "禁止" },
    { en: "dump", ch: "傾倒；丟棄" },
    { en: "welfare", ch: "福利；福祉" },
    { en: "deposit", ch: "存款；押金；沈積" },
    { en: "portray", ch: "描繪；飾演" },
    { en: "dilemmas", ch: "進退兩難的困境" },
    { en: "stereotypes", ch: "刻板印象" },
    { en: "retreat", ch: "撤退；退隱" },
    { en: "assess", ch: "評估；評價" },
    { en: "classify", ch: "分類" },
    { en: "as a result of", ch: "由於...的結果" },
    { en: "regardless", ch: "無論如何；不管" },
    { en: "in return of", ch: "作為...的回報" },
    { en: "marvel", ch: "感到驚奇；奇蹟" },
    { en: "formal", ch: "正式的" },
    { en: "primal", ch: "原始的；最初的" },
    { en: "trim", ch: "修剪；整理" },
    { en: "glaring", ch: "耀眼的；明顯的" },
    { en: "draft", ch: "草稿；徵兵" },
    { en: "plot", ch: "情節；陰謀；標繪" },
    { en: "casual", ch: "隨意的；休閒的" },
    { en: "fragile", ch: "易碎的；脆弱的" },
    { en: "remote", ch: "遙遠的；偏僻的" },
    { en: "enormous", ch: "巨大的；龐大的" },
    { en: "halt", ch: "停止；暫停" },
    { en: "hatch", ch: "孵化；策劃" },
    { en: "reinforce", ch: "加強；增援" },
    { en: "praise", ch: "讚美" },
    { en: "address", ch: "處理；演說；地址" },
    { en: "verbally", ch: "口頭上地" },
    { en: "relevant", ch: "相關的；切題的" },
    { en: "facilitate", ch: "促進；使便利" },
    { en: "disclose", ch: "揭露；公開" },
    { en: "slender", ch: "苗條的；修長的" },
    { en: "apt", ch: "適合的；易於...的" },
    { en: "due", ch: "到期的；預期的；應得的" },
    { en: "dock", ch: "碼頭；停靠" },
    { en: "forceful", ch: "強有力的；有說服力的" },
    { en: "compulsory", ch: "強制的；義務的" },
    { en: "remedy", ch: "治療法；補救" },
    { en: "propose", ch: "提議；求婚" },
    { en: "promise", ch: "承諾；前途" },
    { en: "engage in", ch: "從事；參加" },
    { en: "pose as", ch: "假裝成..." },
    { en: "assign to", ch: "指派給..." },
    { en: "means", ch: "手段；方法" },
    { en: "house", ch: "給...提供住所；收藏" },
    { en: "indulge", ch: "沈溺；縱容" },
    { en: "thrill", ch: "興奮；顫抖" },
    { en: "protest", ch: "抗議" },
    { en: "obtain", ch: "獲得" },
    { en: "intact", ch: "完好無缺的" },
    { en: "embrace", ch: "擁抱；欣然接受" },
    { en: "execute", ch: "執行；處決" },
    { en: "cradle", ch: "搖籃；發源地；輕抱" },
    { en: "grateful", ch: "感激的" },
    { en: "quarreled", ch: "爭吵 (過去式)" },
    { en: "operation", ch: "操作；手術；營運" },
    { en: "keep pet", ch: "飼養寵物" },
    { en: "bare", ch: "赤裸的；僅僅的" },
    { en: "harsh", ch: "嚴厲的；刺耳的" },
    { en: "confine", ch: "限制；監禁" },
    { en: "drill", ch: "鑽孔；訓練" },
    { en: "flush", ch: "沖水；臉紅" },
    { en: "secure", ch: "安全的；獲得；固定" },
    { en: "corporation", ch: "大公司；法人" },
    { en: "immigrate", ch: "移民 (移入)" },
    { en: "interpret", ch: "解釋；口譯" },
    { en: "disregarded", ch: "忽視；不理會" },
    { en: "oral", ch: "口頭的" },
    { en: "insensitive", ch: "不敏感的；沒感覺的" },
    { en: "departure", ch: "離開；出發" },
    { en: "session", ch: "會議；期間；學期" },
    { en: "infertile", ch: "貧瘠的；不孕的" },
    { en: "dynamically", ch: "動態地；充滿活力地" },
    { en: "precisely", ch: "精確地" },
    { en: "content", ch: "內容；滿足的" },
    { en: "perishable", ch: "易腐壞的" },
    { en: "strip", ch: "剝去；條狀物" },
    { en: "proceed", ch: "繼續進行" },
    { en: "recede", ch: "後退；衰退" },
    { en: "recession", ch: "經濟衰退" },
    { en: "reproduce", ch: "繁殖；複製" },
    { en: "reduction", ch: "減少；降低" },
    { en: "come down with", ch: "染上(病)" },
    { en: "take ... for granted", ch: "視...為理所當然" },
    { en: "take advantage of", ch: "利用；佔便宜" },
    { en: "blur", ch: "模糊" },
    { en: "assume", ch: "假設；承擔(責任)" },
    { en: "wounded", ch: "受傷的" },
    { en: "is found in", ch: "被發現於；存在於" },
    { en: "recreational", ch: "娛樂的；休閒的" },
    { en: "amuse", ch: "使快樂；逗笑" },
    { en: "reluctant", ch: "不情願的" },
    { en: "kidnap", ch: "綁架" },
    { en: "imply", ch: "暗示" },
    { en: "summits", ch: "頂峰；高峰會" },
    { en: "documentary", ch: "紀錄片" },
    { en: "representative", ch: "代表性的；代表" },
    { en: "extensive", ch: "廣泛的" },
    { en: "trauma", ch: "創傷" },
    { en: "despaired", ch: "絕望 (過去式)" },
    { en: "penetrated", ch: "穿透；滲透" },
    { en: "valid", ch: "有效的；有根據的" },
    { en: "burden", ch: "負擔" },
    { en: "commend", ch: "稱讚；推薦" },
    { en: "recommend", ch: "推薦" },
    { en: "mature", ch: "成熟的" },
    { en: "quarrel", ch: "爭吵" },
    { en: "temporary", ch: "暫時的" },
    { en: "attain", ch: "達到；獲得" },
    { en: "detain", ch: "拘留；扣押" },
    { en: "retain", ch: "保留；保持" },
    { en: "sustain", ch: "維持；支撐" },
    { en: "neglect", ch: "忽視；疏忽" },
    { en: "dialect", ch: "方言" },
    { en: "venture", ch: "冒險；投機活動" },
    { en: "have a narrow escape", ch: "死裡逃生；千鈞一髮" },
    { en: "characterize", ch: "描述...的特性" },
    { en: "sentimental", ch: "多愁善感的" },
    { en: "roar", ch: "咆哮；吼叫" },
    { en: "soar", ch: "高飛；翱翔；猛增" },
    { en: "primitive", ch: "原始的" },
    { en: "prominent", ch: "顯著的；傑出的" },
    { en: "novel", ch: "新穎的；小說" },
    { en: "flesh", ch: "肉；肉體" },
    { en: "patient", ch: "有耐心的；病人" },
    { en: "inspect", ch: "檢查；視察" },
    { en: "prospect", ch: "前景；展望" },
    { en: "subsist", ch: "生存；維持生活" },
    { en: "persist", ch: "堅持；持續" },
    { en: "artisans", ch: "工匠" },
    { en: "to be prized for sth", ch: "因某事被珍視" },
    { en: "craze", ch: "狂熱；風行一時" },
    { en: "assets", ch: "資產" },
    { en: "a blessing in disguise", ch: "因禍得福" },
    { en: "two peas in a pod", ch: "一模一樣；極為相似" },
    { en: "amid", ch: "在...之中" },
    { en: "pivotal", ch: "關鍵的；中樞的" },
    { en: "immediacy", ch: "即時性；迫切" },
    { en: "narrative", ch: "敘事；故事" },
    { en: "captivate", ch: "使著迷；迷住" },
    { en: "propel", ch: "推進；驅策" },
    { en: "unfold", ch: "展開；呈現" },
    { en: "confront", ch: "面對；對質" },
    { en: "foster", ch: "促進；培養；收養" },
    { en: "compelling", ch: "令人信服的；引人入勝的" },
    { en: "shallow", ch: "淺的；膚淺的" },
    { en: "be treated to something", ch: "被招待享受..." },
    { en: "mimic", ch: "模仿" },
    { en: "eloquent", ch: "雄辯的；有說服力的" },
    { en: "pessimism", ch: "悲觀主義" },
    { en: "maintenance", ch: "維護；保養" },
    { en: "beverage", ch: "飲料" },
    { en: "implement", ch: "實施；執行；工具" },
    { en: "contribute", ch: "貢獻；捐助" },
    { en: "conservation", ch: "保育；保存" },
    { en: "significant", ch: "重要的；顯著的" },
    { en: "mean", ch: "卑鄙的；吝嗇的；意指" },
    { en: "green", ch: "綠色的；環保的；未熟的" },
    { en: "reserve", ch: "保留；預訂；保護區" },
    { en: "devote", ch: "奉獻；致力於" },
    { en: "present", ch: "呈現；出席的；禮物" },
    { en: "civil", ch: "公民的；文明的；國內的" },
    { en: "vicious", ch: "惡毒的；兇殘的" },
    { en: "diverse", ch: "多樣的" },
    { en: "quote", ch: "引用；報價" },
    { en: "courteous", ch: "有禮貌的" },
    { en: "contemporary", ch: "當代的；同時代的" },
    { en: "accommodate", ch: "容納；提供住宿；適應" },
    { en: "gradually", ch: "逐漸地" },
    { en: "vertically", ch: "垂直地" },
    { en: "graciously", ch: "親切地；優雅地" },
    { en: "deliberately", ch: "故意地；慎重地" },
    { en: "may well", ch: "很可能" },
    { en: "stain", ch: "污漬；弄髒" },
    { en: "refund", ch: "退款" },
    { en: "utilize", ch: "利用" },
    { en: "poetic", ch: "詩意的" },
    { en: "vague", ch: "模糊的" },
    { en: "intestine", ch: "腸" },
    { en: "remark", ch: "評論；談論" },
    { en: "provoke", ch: "挑釁；激怒；激起" },
    { en: "overtake", ch: "超車；趕上；突然襲擊" },
    { en: "compensate", ch: "補償；賠償" },
    { en: "elaborate", ch: "詳盡闡述；精細的" },
    { en: "compatible", ch: "相容的；合得來的" },
    { en: "anonymous", ch: "匿名的" },
    { en: "detrimental", ch: "有害的" },
    { en: "be subjected to N", ch: "遭受...；易受...影響" },
    { en: "engaged", ch: "訂婚的；忙碌的；使用中的" },
    { en: "mourning", ch: "哀悼" },
    { en: "go at", ch: "攻擊；努力做" },
    { en: "by chance", ch: "偶然" },
    { en: "take up", ch: "開始從事；佔據(時間空間)" },
    { en: "plain", ch: "樸素的；清楚的；平原" },
    { en: "decline", ch: "婉拒；下降；衰退" },
    { en: "embark on", ch: "著手進行；登上(船)" }
];

// 簡單的洗牌算法
const shuffleArray = (array) => {
    let newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
};

// 移除重複項目 (以英文為準)
const uniqueData = Array.from(new Map(rawData.map(item => [item.en, item])).values());

const App = () => {
    const [gameState, setGameState] = React.useState('start'); // start, quiz, summary
    const [quizQueue, setQuizQueue] = React.useState([]);
    const [currentIndex, setCurrentIndex] = React.useState(0);
    const [score, setScore] = React.useState(0);
    const [wrongAnswers, setWrongAnswers] = React.useState([]);
    const [options, setOptions] = React.useState([]);
    const [selectedOption, setSelectedOption] = React.useState(null); // 'correct' or 'wrong' or null
    const [userChoice, setUserChoice] = React.useState(null);
    const [isPlaying, setIsPlaying] = React.useState(false);

    // 開始測驗初始化
    const startQuiz = (sourceList = uniqueData) => {
        const shuffled = shuffleArray(sourceList);
        setQuizQueue(shuffled);
        setCurrentIndex(0);
        setScore(0);
        setWrongAnswers([]);
        setGameState('quiz');
        generateOptions(shuffled[0], uniqueData);
        setSelectedOption(null);
        setUserChoice(null);
        
        // 自動播放第一題發音 (可選)
        // setTimeout(() => speak(shuffled[0].en), 500);
    };

    // 產生選項
    const generateOptions = (currentWord, fullList) => {
        const otherWords = fullList.filter(w => w.en !== currentWord.en);
        const distractors = shuffleArray(otherWords).slice(0, 3);
        const allOptions = shuffleArray([currentWord, ...distractors]);
        setOptions(allOptions);
    };

    // 處理回答
    const handleAnswer = (option) => {
        if (selectedOption) return; // 防止重複點擊

        setUserChoice(option.en);
        const currentWord = quizQueue[currentIndex];
        const isCorrect = option.en === currentWord.en;

        if (isCorrect) {
            setScore(prev => prev + 1);
            setSelectedOption('correct');
        } else {
            setWrongAnswers(prev => [...prev, currentWord]);
            setSelectedOption('wrong');
        }

        // 延遲進入下一題
        setTimeout(() => {
            if (currentIndex + 1 < quizQueue.length) {
                const nextIndex = currentIndex + 1;
                setCurrentIndex(nextIndex);
                generateOptions(quizQueue[nextIndex], uniqueData);
                setSelectedOption(null);
                setUserChoice(null);
            } else {
                setGameState('summary');
            }
        }, 1200); // 1.2秒後換下一題
    };

    // 增強版發音功能
    const speak = (text) => {
        setIsPlaying(true);
        
        // 1. 清除之前的語音
        window.speechSynthesis.cancel();

        // 2. 優先嘗試線上 API (Youdao Dict - type 2 為美式發音)
        const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
        const audio = new Audio(audioUrl);

        // 處理播放結束，重置按鈕狀態
        audio.onended = () => setIsPlaying(false);

        audio.play()
            .then(() => {
                // 播放成功
            })
            .catch((e) => {
                console.warn("Online audio failed, switching to fallback TTS", e);
                
                // 3. 如果線上播放失敗，降級使用瀏覽器 TTS
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8; // 稍微慢一點點
                    utterance.onend = () => setIsPlaying(false);
                    utterance.onerror = () => setIsPlaying(false);
                    
                    // 嘗試尋找並指定美式發音的 Voice
                    const voices = window.speechSynthesis.getVoices();
                    const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) || 
                                  voices.find(v => v.lang === 'en-US');
                    if (enVoice) utterance.voice = enVoice;

                    window.speechSynthesis.speak(utterance);
                } catch (ttsError) {
                    console.error("TTS also failed", ttsError);
                    setIsPlaying(false);
                }
            });
    };

    // 確保組件掛載時載入 voices (針對 Chrome)
    React.useEffect(() => {
        const loadVoices = () => { window.speechSynthesis.getVoices(); };
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }, []);

    // 重試錯題
    const retryMissed = () => {
        startQuiz(wrongAnswers);
    };

    if (gameState === 'start') {
        return (
            <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-sm mx-auto fade-in">
                <div className="text-6xl mb-6 text-indigo-500">
                    <i className="fa-solid fa-graduation-cap"></i>
                </div>
                <h1 className="text-3xl font-bold text-gray-800 mb-2">單字特訓班</h1>
                <p className="text-gray-500 mb-8">
                    共收錄 {uniqueData.length} 個高頻單字。<br/>準備好接受挑戰了嗎？
                </p>
                <button 
                    onClick={() => startQuiz()}
                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 shadow-lg transform hover:-translate-y-1"
                >
                    開始測驗
                </button>
            </div>
        );
    }

    if (gameState === 'summary') {
        return (
            <div className="bg-white rounded-2xl shadow-xl p-6 w-full fade-in h-[80vh] flex flex-col">
                <div className="text-center mb-6">
                    <h2 className="text-2xl font-bold text-gray-800">測驗完成！</h2>
                    <p className="text-gray-500 mt-2">
                        得分：<span className="text-indigo-600 font-bold text-xl">{score}</span> / {quizQueue.length}
                    </p>
                </div>

                <div className="flex-1 overflow-y-auto mb-6 pr-2">
                    {wrongAnswers.length === 0 ? (
                        <div className="text-center text-green-600 py-10">
                            <i className="fa-solid fa-trophy text-5xl mb-4"></i>
                            <p className="font-bold">太強了！全部答對！</p>
                        </div>
                    ) : (
                        <div>
                            <h3 className="text-red-500 font-bold mb-3 border-b pb-2">需複習的單字 ({wrongAnswers.length})</h3>
                            <ul className="space-y-3">
                                {wrongAnswers.map((item, idx) => (
                                    <li key={idx} className="flex justify-between items-center bg-red-50 p-3 rounded-lg">
                                        <div>
                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                {item.en}
                                                <button onClick={() => speak(item.en)} className="text-gray-400 hover:text-indigo-600 text-sm w-8 h-8 flex items-center justify-center rounded-full hover:bg-white transition">
                                                    <i className="fa-solid fa-volume-high"></i>
                                                </button>
                                            </div>
                                            <div className="text-sm text-gray-600">{item.ch}</div>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {wrongAnswers.length > 0 && (
                        <button 
                            onClick={retryMissed}
                            className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-xl transition shadow"
                        >
                            複習錯題
                        </button>
                    )}
                    <button 
                        onClick={() => startQuiz()}
                        className={`bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition shadow ${wrongAnswers.length === 0 ? 'col-span-2' : ''}`}
                    >
                        全部重測
                    </button>
                </div>
            </div>
        );
    }

    const currentWord = quizQueue[currentIndex];
    const progress = Math.round(((currentIndex) / quizQueue.length) * 100);

    return (
        <div className="bg-white rounded-2xl shadow-xl w-full overflow-hidden flex flex-col h-[600px] relative">
            {/* 進度條 */}
            <div className="w-full bg-gray-200 h-2">
                <div 
                    className="bg-indigo-500 h-2 transition-all duration-300"
                    style={{ width: `${progress}%` }}
                ></div>
            </div>

            {/* 頂部資訊 */}
            <div className="flex justify-between items-center px-6 py-4 border-b">
                <span className="text-gray-500 font-medium">Q{currentIndex + 1} / {quizQueue.length}</span>
                <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">
                    Score: {score}
                </span>
            </div>

            {/* 主要單字區 */}
            <div className="flex-1 flex flex-col items-center justify-center p-6 bg-slate-50">
                <div className="text-center">
                    <h2 className="text-4xl font-bold text-gray-800 mb-4 break-words fade-in">
                        {currentWord.en}
                    </h2>
                    <button 
                        onClick={() => speak(currentWord.en)}
                        disabled={isPlaying}
                        className={`w-14 h-14 rounded-full shadow-md text-xl flex items-center justify-center mx-auto transition-all ${isPlaying ? 'bg-indigo-500 text-white scale-110' : 'bg-white text-indigo-500 hover:bg-indigo-500 hover:text-white'}`}
                    >
                        {isPlaying ? <i className="fa-solid fa-volume-high animate-pulse"></i> : <i className="fa-solid fa-volume-high"></i>}
                    </button>
                    <p className="text-xs text-gray-400 mt-2">點擊發音</p>
                </div>
            </div>

            {/* 選項區 */}
            <div className="p-6 bg-white space-y-3">
                {options.map((option, idx) => {
                    let btnClass = "w-full text-left p-4 rounded-xl border-2 font-medium text-lg transition-all duration-200 transform ";
                    
                    if (selectedOption) {
                        if (option.en === currentWord.en) {
                            // 正確答案顯示綠色
                            btnClass += "border-green-500 bg-green-50 text-green-700";
                        } else if (option.en === userChoice) {
                            // 選錯的顯示紅色
                            btnClass += "border-red-500 bg-red-50 text-red-700";
                        } else {
                            // 其他選項變淡
                            btnClass += "border-gray-100 text-gray-300";
                        }
                    } else {
                        // 尚未選擇
                        btnClass += "border-gray-200 text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md active:scale-98 cursor-pointer";
                    }

                    return (
                        <button 
                            key={idx} 
                            onClick={() => handleAnswer(option)}
                            disabled={!!selectedOption}
                            className={btnClass}
                        >
                            <span className="mr-3 text-gray-400 text-sm font-bold">{String.fromCharCode(65 + idx)}.</span>
                            {option.ch}
                            {selectedOption && option.en === currentWord.en && <i className="fa-solid fa-check float-right mt-1"></i>}
                            {selectedOption && option.en === userChoice && option.en !== currentWord.en && <i className="fa-solid fa-xmark float-right mt-1"></i>}
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

</body>
</html>

    { en: "indulge", ch: "沈溺；縱容" },
    { en: "thrill", ch: "興奮；顫抖" },
    { en: "protest", ch: "抗議" },
    { en: "obtain", ch: "獲得" },
    { en: "intact", ch: "完好無缺的" },
    { en: "embrace", ch: "擁抱；欣然接受" },
    { en: "execute", ch: "執行；處決" },
    { en: "cradle", ch: "搖籃；發源地；輕抱" },
    { en: "grateful", ch: "感激的" },
    { en: "quarreled", ch: "爭吵 (過去式)" },
    { en: "operation", ch: "操作；手術；營運" },
    { en: "keep pet", ch: "飼養寵物" },
    { en: "bare", ch: "赤裸的；僅僅的" },
    { en: "harsh", ch: "嚴厲的；刺耳的" },
    { en: "confine", ch: "限制；監禁" },
    { en: "drill", ch: "鑽孔；訓練" },
    { en: "flush", ch: "沖水；臉紅" },
    { en: "secure", ch: "安全的；獲得；固定" },
    { en: "corporation", ch: "大公司；法人" },
    { en: "immigrate", ch: "移民 (移入)" },
    { en: "interpret", ch: "解釋；口譯" },
    { en: "disregarded", ch: "忽視；不理會" },
    { en: "oral", ch: "口頭的" },
    { en: "insensitive", ch: "不敏感的；沒感覺的" },
    { en: "departure", ch: "離開；出發" },
    { en: "session", ch: "會議；期間；學期" },
    { en: "infertile", ch: "貧瘠的；不孕的" },
    { en: "dynamically", ch: "動態地；充滿活力地" },
    { en: "precisely", ch: "精確地" },
    { en: "content", ch: "內容；滿足的" },
    { en: "perishable", ch: "易腐壞的" },
    { en: "strip", ch: "剝去；條狀物" },
    { en: "proceed", ch: "繼續進行" },
    { en: "recede", ch: "後退；衰退" },
    { en: "recession", ch: "經濟衰退" },
    { en: "reproduce", ch: "繁殖；複製" },
    { en: "reduction", ch: "減少；降低" },
    { en: "come down with", ch: "染上(病)" },
    { en: "take ... for granted", ch: "視...為理所當然" },
    { en: "take advantage of", ch: "利用；佔便宜" },
    { en: "blur", ch: "模糊" },
    { en: "assume", ch: "假設；承擔(責任)" },
    { en: "wounded", ch: "受傷的" },
    { en: "is found in", ch: "被發現於；存在於" },
    { en: "recreational", ch: "娛樂的；休閒的" },
    { en: "amuse", ch: "使快樂；逗笑" },
    { en: "reluctant", ch: "不情願的" },
    { en: "kidnap", ch: "綁架" },
    { en: "imply", ch: "暗示" },
    { en: "summits", ch: "頂峰；高峰會" },
    { en: "documentary", ch: "紀錄片" },
    { en: "representative", ch: "代表性的；代表" },
    { en: "extensive", ch: "廣泛的" },
    { en: "trauma", ch: "創傷" },
    { en: "despaired", ch: "絕望 (過去式)" },
    { en: "penetrated", ch: "穿透；滲透" },
    { en: "valid", ch: "有效的；有根據的" },
    { en: "burden", ch: "負擔" },
    { en: "commend", ch: "稱讚；推薦" },
    { en: "recommend", ch: "推薦" },
    { en: "mature", ch: "成熟的" },
    { en: "quarrel", ch: "爭吵" },
    { en: "temporary", ch: "暫時的" },
    { en: "attain", ch: "達到；獲得" },
    { en: "detain", ch: "拘留；扣押" },
    { en: "retain", ch: "保留；保持" },
    { en: "sustain", ch: "維持；支撐" },
    { en: "neglect", ch: "忽視；疏忽" },
    { en: "dialect", ch: "方言" },
    { en: "venture", ch: "冒險；投機活動" },
    { en: "have a narrow escape", ch: "死裡逃生；千鈞一髮" },
    { en: "characterize", ch: "描述...的特性" },
    { en: "sentimental", ch: "多愁善感的" },
    { en: "roar", ch: "咆哮；吼叫" },
    { en: "soar", ch: "高飛；翱翔；猛增" },
    { en: "primitive", ch: "原始的" },
    { en: "prominent", ch: "顯著的；傑出的" },
    { en: "novel", ch: "新穎的；小說" },
    { en: "flesh", ch: "肉；肉體" },
    { en: "patient", ch: "有耐心的；病人" },
    { en: "inspect", ch: "檢查；視察" },
    { en: "prospect", ch: "前景；展望" },
    { en: "subsist", ch: "生存；維持生活" },
    { en: "persist", ch: "堅持；持續" },
    { en: "artisans", ch: "工匠" },
    { en: "to be prized for sth", ch: "因某事被珍視" },
    { en: "craze", ch: "狂熱；風行一時" },
    { en: "assets", ch: "資產" },
    { en: "a blessing in disguise", ch: "因禍得福" },
    { en: "two peas in a pod", ch: "一模一樣；極為相似" },
    { en: "amid", ch: "在...之中" },
    { en: "pivotal", ch: "關鍵的；中樞的" },
    { en: "immediacy", ch: "即時性；迫切" },
    { en: "narrative", ch: "敘事；故事" },
    { en: "captivate", ch: "使著迷；迷住" },
    { en: "propel", ch: "推進；驅策" },
    { en: "unfold", ch: "展開；呈現" },
    { en: "confront", ch: "面對；對質" },
    { en: "foster", ch: "促進；培養；收養" },
    { en: "compelling", ch: "令人信服的；引人入勝的" },
    { en: "shallow", ch: "淺的；膚淺的" },
    { en: "be treated to something", ch: "被招待享受..." },
    { en: "mimic", ch: "模仿" },
    { en: "eloquent", ch: "雄辯的；有說服力的" },
    { en: "pessimism", ch: "悲觀主義" },
    { en: "maintenance", ch: "維護；保養" },
    { en: "beverage", ch: "飲料" },
    { en: "implement", ch: "實施；執行；工具" },
    { en: "contribute", ch: "貢獻；捐助" },
    { en: "conservation", ch: "保育；保存" },
    { en: "significant", ch: "重要的；顯著的" },
    { en: "mean", ch: "卑鄙的；吝嗇的；意指" },
    { en: "green", ch: "綠色的；環保的；未熟的" },
    { en: "reserve", ch: "保留；預訂；保護區" },
    { en: "devote", ch: "奉獻；致力於" },
    { en: "present", ch: "呈現；出席的；禮物" },
    { en: "civil", ch: "公民的；文明的；國內的" },
    { en: "vicious", ch: "惡毒的；兇殘的" },
    { en: "diverse", ch: "多樣的" },
    { en: "quote", ch: "引用；報價" },
    { en: "courteous", ch: "有禮貌的" },
    { en: "contemporary", ch: "當代的；同時代的" },
    { en: "accommodate", ch: "容納；提供住宿；適應" },
    { en: "gradually", ch: "逐漸地" },
    { en: "vertically", ch: "垂直地" },
    { en: "graciously", ch: "親切地；優雅地" },
    { en: "deliberately", ch: "故意地；慎重地" },
    { en: "may well", ch: "很可能" },
    { en: "stain", ch: "污漬；弄髒" },
    { en: "refund", ch: "退款" },
    { en: "utilize", ch: "利用" },
    { en: "poetic", ch: "詩意的" },
    { en: "vague", ch: "模糊的" },
    { en: "intestine", ch: "腸" },
    { en: "remark", ch: "評論；談論" },
    { en: "provoke", ch: "挑釁；激怒；激起" },
    { en: "overtake", ch: "超車；趕上；突然襲擊" },
    { en: "compensate", ch: "補償；賠償" },
    { en: "elaborate", ch: "詳盡闡述；精細的" },
    { en: "compatible", ch: "相容的；合得來的" },
    { en: "anonymous", ch: "匿名的" },
    { en: "detrimental", ch: "有害的" },
    { en: "be subjected to N", ch: "遭受...；易受...影響" },
    { en: "engaged", ch: "訂婚的；忙碌的；使用中的" },
    { en: "mourning", ch: "哀悼" },
    { en: "go at", ch: "攻擊；努力做" },
    { en: "by chance", ch: "偶然" },
    { en: "take up", ch: "開始從事；佔據(時間空間)" },
    { en: "plain", ch: "樸素的；清楚的；平原" },
    { en: "decline", ch: "婉拒；下降；衰退" },
    { en: "embark on", ch: "著手進行；登上(船)" }
];

// 簡單的洗牌算法
const shuffleArray = (array) => {
    let newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
};

// 移除重複項目 (以英文為準)
const uniqueData = Array.from(new Map(rawData.map(item => [item.en, item])).values());

const App = () => {
    const [gameState, setGameState] = React.useState('start'); // start, quiz, summary
    const [quizQueue, setQuizQueue] = React.useState([]);
    const [currentIndex, setCurrentIndex] = React.useState(0);
    const [score, setScore] = React.useState(0);
    const [wrongAnswers, setWrongAnswers] = React.useState([]);
    const [options, setOptions] = React.useState([]);
    const [selectedOption, setSelectedOption] = React.useState(null); // 'correct' or 'wrong' or null
    const [userChoice, setUserChoice] = React.useState(null);

    // 開始測驗初始化
    const startQuiz = (sourceList = uniqueData) => {
        const shuffled = shuffleArray(sourceList);
        setQuizQueue(shuffled);
        setCurrentIndex(0);
        setScore(0);
        setWrongAnswers([]);
        setGameState('quiz');
        generateOptions(shuffled[0], uniqueData);
        setSelectedOption(null);
        setUserChoice(null);
    };

    // 產生選項
    const generateOptions = (currentWord, fullList) => {
        const otherWords = fullList.filter(w => w.en !== currentWord.en);
        const distractors = shuffleArray(otherWords).slice(0, 3);
        const allOptions = shuffleArray([currentWord, ...distractors]);
        setOptions(allOptions);
    };

    // 處理回答
    const handleAnswer = (option) => {
        if (selectedOption) return; // 防止重複點擊

        setUserChoice(option.en);
        const currentWord = quizQueue[currentIndex];
        const isCorrect = option.en === currentWord.en;

        if (isCorrect) {
            setScore(prev => prev + 1);
            setSelectedOption('correct');
        } else {
            setWrongAnswers(prev => [...prev, currentWord]);
            setSelectedOption('wrong');
        }

        // 延遲進入下一題
        setTimeout(() => {
            if (currentIndex + 1 < quizQueue.length) {
                const nextIndex = currentIndex + 1;
                setCurrentIndex(nextIndex);
                generateOptions(quizQueue[nextIndex], uniqueData);
                setSelectedOption(null);
                setUserChoice(null);
            } else {
                setGameState('summary');
            }
        }, 1200); // 1.2秒後換下一題
    };

    // 發音功能
    const speak = (text) => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        window.speechSynthesis.speak(utterance);
    };

    // 重試錯題
    const retryMissed = () => {
        startQuiz(wrongAnswers);
    };

    if (gameState === 'start') {
        return (
            <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-sm mx-auto fade-in">
                <div className="text-6xl mb-6 text-indigo-500">
                    <i className="fa-solid fa-graduation-cap"></i>
                </div>
                <h1 className="text-3xl font-bold text-gray-800 mb-2">單字特訓班</h1>
                <p className="text-gray-500 mb-8">
                    共收錄 {uniqueData.length} 個高頻單字。<br/>準備好接受挑戰了嗎？
                </p>
                <button 
                    onClick={() => startQuiz()}
                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 shadow-lg transform hover:-translate-y-1"
                >
                    開始測驗
                </button>
            </div>
        );
    }

    if (gameState === 'summary') {
        return (
            <div className="bg-white rounded-2xl shadow-xl p-6 w-full fade-in h-[80vh] flex flex-col">
                <div className="text-center mb-6">
                    <h2 className="text-2xl font-bold text-gray-800">測驗完成！</h2>
                    <p className="text-gray-500 mt-2">
                        得分：<span className="text-indigo-600 font-bold text-xl">{score}</span> / {quizQueue.length}
                    </p>
                </div>

                <div className="flex-1 overflow-y-auto mb-6 pr-2">
                    {wrongAnswers.length === 0 ? (
                        <div className="text-center text-green-600 py-10">
                            <i className="fa-solid fa-trophy text-5xl mb-4"></i>
                            <p className="font-bold">太強了！全部答對！</p>
                        </div>
                    ) : (
                        <div>
                            <h3 className="text-red-500 font-bold mb-3 border-b pb-2">需複習的單字 ({wrongAnswers.length})</h3>
                            <ul className="space-y-3">
                                {wrongAnswers.map((item, idx) => (
                                    <li key={idx} className="flex justify-between items-center bg-red-50 p-3 rounded-lg">
                                        <div>
                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                {item.en}
                                                <button onClick={() => speak(item.en)} className="text-gray-400 hover:text-indigo-600 text-sm">
                                                    <i className="fa-solid fa-volume-high"></i>
                                                </button>
                                            </div>
                                            <div className="text-sm text-gray-600">{item.ch}</div>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {wrongAnswers.length > 0 && (
                        <button 
                            onClick={retryMissed}
                            className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-xl transition shadow"
                        >
                            複習錯題
                        </button>
                    )}
                    <button 
                        onClick={() => startQuiz()}
                        className={`bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition shadow ${wrongAnswers.length === 0 ? 'col-span-2' : ''}`}
                    >
                        全部重測
                    </button>
                </div>
            </div>
        );
    }

    const currentWord = quizQueue[currentIndex];
    const progress = Math.round(((currentIndex) / quizQueue.length) * 100);

    return (
        <div className="bg-white rounded-2xl shadow-xl w-full overflow-hidden flex flex-col h-[600px] relative">
            {/* 進度條 */}
            <div className="w-full bg-gray-200 h-2">
                <div 
                    className="bg-indigo-500 h-2 transition-all duration-300"
                    style={{ width: `${progress}%` }}
                ></div>
            </div>

            {/* 頂部資訊 */}
            <div className="flex justify-between items-center px-6 py-4 border-b">
                <span className="text-gray-500 font-medium">Q{currentIndex + 1} / {quizQueue.length}</span>
                <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">
                    Score: {score}
                </span>
            </div>

            {/* 主要單字區 */}
            <div className="flex-1 flex flex-col items-center justify-center p-6 bg-slate-50">
                <div className="text-center">
                    <h2 className="text-4xl font-bold text-gray-800 mb-4 break-words fade-in">
                        {currentWord.en}
                    </h2>
                    <button 
                        onClick={() => speak(currentWord.en)}
                        className="w-12 h-12 rounded-full bg-white shadow-md text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all text-xl flex items-center justify-center mx-auto"
                    >
                        <i className="fa-solid fa-volume-high"></i>
                    </button>
                </div>
            </div>

            {/* 選項區 */}
            <div className="p-6 bg-white space-y-3">
                {options.map((option, idx) => {
                    let btnClass = "w-full text-left p-4 rounded-xl border-2 font-medium text-lg transition-all duration-200 transform ";
                    
                    if (selectedOption) {
                        if (option.en === currentWord.en) {
                            // 正確答案顯示綠色
                            btnClass += "border-green-500 bg-green-50 text-green-700";
                        } else if (option.en === userChoice) {
                            // 選錯的顯示紅色
                            btnClass += "border-red-500 bg-red-50 text-red-700";
                        } else {
                            // 其他選項變淡
                            btnClass += "border-gray-100 text-gray-300";
                        }
                    } else {
                        // 尚未選擇
                        btnClass += "border-gray-200 text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md active:scale-98 cursor-pointer";
                    }

                    return (
                        <button 
                            key={idx} 
                            onClick={() => handleAnswer(option)}
                            disabled={!!selectedOption}
                            className={btnClass}
                        >
                            <span className="mr-3 text-gray-400 text-sm font-bold">{String.fromCharCode(65 + idx)}.</span>
                            {option.ch}
                            {selectedOption && option.en === currentWord.en && <i className="fa-solid fa-check float-right mt-1"></i>}
                            {selectedOption && option.en === userChoice && option.en !== currentWord.en && <i className="fa-solid fa-xmark float-right mt-1"></i>}
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

</body>
</html>

